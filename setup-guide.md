# QRコード読み取り & Slack連携アプリケーション - セットアップガイド

このガイドでは、QRコード読み取り & Slack連携アプリケーションを正しく設定し、画像付きでSlackに送信できるようにするための手順を説明します。

## 1. 概要

このアプリケーションは、以下の機能を提供します：

- QRコードの読み取り
- トレイ画像の撮影
- QRコードデータとトレイ画像のSlackへの送信

画像付きでSlackに送信するには、CORS（Cross-Origin Resource Sharing）制限を回避するためのプロキシが必要です。このガイドでは、Cloudflare Workersを使用したプロキシの設定方法も説明します。

## 2. ステップバイステップのセットアップ手順

### 2.1. Slack Bot Tokenの取得

1. [Slack API公式サイト](https://api.slack.com/apps)にアクセスします
2. 「Create New App」ボタンをクリックします
3. 「From scratch」を選択します
4. アプリ名（例：「QR Scanner Bot」）とワークスペースを選択して「Create App」をクリックします
5. 左側メニューの「OAuth & Permissions」をクリックします
6. 「Bot Token Scopes」セクションで「Add an OAuth Scope」ボタンをクリックし、以下の権限を追加します：
   - `chat:write`（メッセージを送信するため）
   - `files:write`（ファイルをアップロードするため）
   - `channels:read`（チャンネル情報を読み取るため）
7. ページ上部の「Install to Workspace」ボタンをクリックしてアプリをインストールします
8. インストール後、「Bot User OAuth Token」が表示されます。このトークンを安全な場所にコピーします（`xoxb-` で始まる文字列）

### 2.2. Slackチャンネルの準備

1. Botを招待したいチャンネルを開きます
2. チャンネル名の横にある下矢印をクリックし、「チャンネルの詳細を表示」を選択します
3. 「その他」をクリックし、「チャンネル情報をコピー」を選択します
4. チャンネルID（`C01...` で始まる文字列）をコピーします
5. チャンネルに戻り、メッセージ入力欄に `/invite @ボット名` と入力して送信し、Botをチャンネルに招待します

### 2.3. Cloudflare Workersの設定

1. [Cloudflare公式サイト](https://dash.cloudflare.com/sign-up)にアクセスします
2. メールアドレスとパスワードを入力して新規アカウントを作成するか、既存のアカウントでログインします
3. 左側のメニューから「**Workers & Pages**」を選択します
4. 「**Create application**」ボタンをクリックします
5. 「**Create Worker**」を選択します
6. Worker名を入力します（例：`slack-proxy`）
7. 「**Deploy**」ボタンをクリックします
8. Workerが作成されたら、「**Edit code**」ボタンをクリックします
9. エディタに表示されるデフォルトのコードをすべて削除します
10. 添付の `cloudflare-worker.js` ファイルの内容をコピー＆ペーストします
11. 「**Save and deploy**」ボタンをクリックします
12. デプロイが完了したら、ブラウザのアドレスバーに表示されているURLをコピーします
    - 例：`https://slack-proxy.your-username.workers.dev`
13. このURLに `/proxy/` を追加したものがプロキシURLになります
    - 例：`https://slack-proxy.your-username.workers.dev/proxy/`

### 2.4. アプリケーションのデプロイ

#### GitHubページを使用する場合：

1. GitHubで新しいリポジトリを作成します
2. 添付のZIPファイルを解凍し、すべてのファイルをリポジトリにアップロードします
3. リポジトリの「Settings」→「Pages」を開きます
4. ソースとして「main」ブランチと「/(root)」フォルダを選択します
5. 「Save」ボタンをクリックします
6. 数分後、GitHubページのURLが表示されます（例：`https://username.github.io/repository-name/`）

#### ローカルで使用する場合：

1. 添付のZIPファイルを任意のフォルダに解凍します
2. `index.html` ファイルをブラウザで開きます
   - 注意：カメラ機能を使用するには、HTTPSまたはローカルホスト環境が必要です

### 2.5. アプリケーションの設定

1. デプロイしたアプリケーションにアクセスします
2. 右上の「設定」ボタンをクリックします
3. 以下の情報を入力します：
   - Bot User OAuth Token：Slack APIから取得したトークン
   - チャンネルID：送信先のSlackチャンネルID
   - プロキシURL：Cloudflare Workersのエンドポイント（末尾の `/proxy/` を含む）
4. 「保存」ボタンをクリックします

## 3. 使用方法

1. QRコードをスキャンします
   - カメラへのアクセスを許可してください
   - QRコードが読み取られると、内容が表示されます
2. 「撮影」ボタンをクリックしてトレイ画像を撮影します
3. 送信方法を選択します：
   - 「Slackに送信」ボタン：QRコードデータとトレイ画像を送信（プロキシ設定が必要）
   - 「テキストのみ送信」ボタン：QRコードデータのみを送信（プロキシなしでも動作）

## 4. トラブルシューティング

### 画像送信時にエラーが発生する場合：

1. プロキシURLが正しく設定されているか確認します
   - 末尾に `/proxy/` が含まれているか確認してください
   - ブラウザのコンソールでエラーメッセージを確認してください
2. Cloudflare Workersが正常に動作しているか確認します
   - ブラウザでプロキシURLにアクセスし、「Slack API Proxy is running」というメッセージが表示されるか確認してください
3. Bot Tokenに必要な権限があるか確認します
   - `chat:write`、`files:write`、`channels:read` の権限が必要です
4. Botがチャンネルに招待されているか確認します
   - `/invite @ボット名` コマンドでチャンネルに招待してください

### カメラが起動しない場合：

1. ブラウザのカメラ権限設定を確認します
   - サイト設定でカメラへのアクセスを許可してください
2. HTTPSまたはローカルホスト環境で実行しているか確認します
   - セキュリティ上の理由から、カメラ機能はHTTPSまたはローカルホスト環境でのみ動作します

## 5. 技術的な詳細

このアプリケーションは、Slack APIの最新の変更に対応しています：

- 非推奨になった `files.upload` APIの代わりに、新しい `files.getUploadURLExternal` + `files.completeUploadExternal` APIを使用
- CORS制限を回避するために、Cloudflare Workersを使用したプロキシを実装
- 画像アップロードとAPI呼び出しの両方をプロキシ経由で処理

詳細な技術情報やカスタマイズ方法については、ソースコードのコメントを参照してください。
