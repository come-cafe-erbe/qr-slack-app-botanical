<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QRコード読み取り & Slack連携アプリ</title>
    <link rel="stylesheet" href="css/botanical-theme.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>
    <header>
        <div class="logo-container">
            <h1>QRコード読み取り & Slack連携アプリ</h1>
        </div>
        <button id="settingsButton" class="btn settings-btn"><i class="fas fa-cog"></i></button>
    </header>

    <div class="page-container">
        <!-- ホーム画面 -->
        <div id="homePage" class="page home-page active">
            <div class="leaf-decoration leaf-top-right"></div>
            <div class="leaf-decoration leaf-bottom-left"></div>
            
            <div class="home-content">
                <h2 class="home-title">QRコード読み取り & Slack連携</h2>
                <p class="home-subtitle">トレイのQRコードをスキャンして、画像と情報をSlackに送信します</p>
                <button id="startScanButton" class="btn btn-large pulse">QRコードをスキャンする</button>
            </div>
        </div>

        <!-- QR読み取り画面 -->
        <div id="scanPage" class="page">
            <button id="backToHomeButton" class="btn back-btn"><i class="fas fa-arrow-left"></i> 戻る</button>
            
            <h2>QRコードをスキャンしてください</h2>
            
            <div class="camera-container">
                <div class="camera-view">
                    <!-- 実際の実装ではここにvideo要素が入ります -->
                    <div style="width: 100%; height: 100%; background-color: #000; display: flex; justify-content: center; align-items: center; color: white;">
                        カメラプレビュー
                    </div>
                    
                    <div class="camera-overlay">
                        <div class="qr-frame">
                            <div class="qr-corner qr-corner-tl"></div>
                            <div class="qr-corner qr-corner-tr"></div>
                            <div class="qr-corner qr-corner-bl"></div>
                            <div class="qr-corner qr-corner-br"></div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="result-display" id="qrResult" style="display: none;">
                QRコード情報: 注文ID: 12345, トークン: ABC123
            </div>
        </div>

        <!-- トレイ撮影画面 -->
        <div id="capturePage" class="page">
            <button id="backToScanButton" class="btn back-btn"><i class="fas fa-arrow-left"></i> 戻る</button>
            
            <h2>トレイを撮影してください</h2>
            
            <div class="result-display">
                QRコード情報: 注文ID: 12345, トークン: ABC123
            </div>
            
            <div class="camera-container">
                <div class="camera-view">
                    <!-- 実際の実装ではここにvideo要素が入ります -->
                    <div style="width: 100%; height: 100%; background-color: #000; display: flex; justify-content: center; align-items: center; color: white;">
                        カメラプレビュー
                    </div>
                </div>
            </div>
            
            <button id="captureButton" class="btn btn-large btn-light pulse">
                <i class="fas fa-camera"></i> トレイを撮影
            </button>
        </div>

        <!-- 確認画面 -->
        <div id="confirmPage" class="page">
            <button id="backToCaptureButton" class="btn back-btn"><i class="fas fa-arrow-left"></i> 戻る</button>
            
            <h2>送信内容を確認してください</h2>
            
            <div class="result-display">
                QRコード情報: 注文ID: 12345, トークン: ABC123
            </div>
            
            <div class="camera-container">
                <div class="camera-view" style="background-color: #333; display: flex; justify-content: center; align-items: center; color: white;">
                    撮影画像プレビュー
                </div>
            </div>
            
            <div style="display: flex; flex-direction: column; align-items: center; width: 100%; max-width: 600px;">
                <button id="sendButton" class="btn btn-large">
                    <i class="fab fa-slack"></i> Slackに送信
                </button>
                <button id="sendTextOnlyButton" class="btn btn-accent">
                    <i class="fas fa-comment-alt"></i> テキストのみ送信
                </button>
                <button id="retakeButton" class="btn btn-light">
                    <i class="fas fa-redo"></i> 撮り直す
                </button>
            </div>
        </div>

        <!-- 完了画面 -->
        <div id="completionPage" class="page completion-page">
            <div class="completion-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <div class="completion-message">送信が完了しました！</div>
            
            <div class="completion-details">
                <p><strong>送信内容:</strong></p>
                <p>QRコード情報: 注文ID: 12345, トークン: ABC123</p>
                <p>トレイ画像が添付されています</p>
                <p><strong>送信先:</strong> #general</p>
            </div>
            
            <div class="countdown">3秒後にホーム画面に戻ります...</div>
            
            <button id="backToHomeFromCompletionButton" class="btn">
                <i class="fas fa-home"></i> ホームに戻る
            </button>
        </div>
    </div>

    <!-- 設定モーダル -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>設定</h2>
            <div class="form-group">
                <label for="botToken">Bot Token</label>
                <input type="text" id="botToken" placeholder="xoxb-...">
            </div>
            <div class="form-group">
                <label for="channelId">チャンネルID</label>
                <input type="text" id="channelId" placeholder="C...">
            </div>
            <div class="form-group">
                <label for="proxyUrl">プロキシURL</label>
                <input type="text" id="proxyUrl" placeholder="https://...">
            </div>
            <button id="saveSettings" class="btn">保存</button>
            <div id="settingsStatus" class="status-message"></div>
        </div>
    </div>

    <script>
document.addEventListener('DOMContentLoaded', function() {
    // ページ要素
    const homePage = document.getElementById('homePage');
    const scanPage = document.getElementById('scanPage');
    const capturePage = document.getElementById('capturePage');
    const confirmPage = document.getElementById('confirmPage');
    const completionPage = document.getElementById('completionPage');
    
    // ボタン要素
    const startScanButton = document.getElementById('startScanButton');
    const backToHomeButton = document.getElementById('backToHomeButton');
    const backToScanButton = document.getElementById('backToScanButton');
    const backToCaptureButton = document.getElementById('backToCaptureButton');
    const retakeButton = document.getElementById('retakeButton');
    const backToHomeFromCompletionButton = document.getElementById('backToHomeFromCompletionButton');
    
    // 設定モーダル関連
    const settingsButton = document.getElementById('settingsButton');
    const settingsModal = document.getElementById('settingsModal');
    const closeButton = document.querySelector('.close');
    const saveSettingsButton = document.getElementById('saveSettings');
    
    // グローバル状態変数
    let currentPage = 'home';
    let isTransitioning = false;
    
    // ページ遷移関数
    function navigateTo(fromPage, toPage, pageName) {
        if (isTransitioning) return;
        isTransitioning = true;
        
        fromPage.classList.remove('active');
        fromPage.classList.add('previous');
        
        setTimeout(() => {
            toPage.classList.add('active');
            currentPage = pageName || '';
            
            setTimeout(() => {
                fromPage.classList.remove('previous');
                fromPage.style.transform = 'translateX(100%)';
                
                setTimeout(() => {
                    fromPage.style.transform = '';
                    isTransitioning = false;
                }, 50);
            }, 500);
        }, 50);
    }
    
    // ホーム → スキャン
    if (startScanButton) {
        startScanButton.addEventListener('click', function() {
            navigateTo(homePage, scanPage, 'scan');
            
            // 少し遅延させてQRスキャナーを初期化
            setTimeout(() => {
                console.log('QRスキャナー初期化開始');
                initQRScanner(function(qrData) {
                    console.log('QRコードスキャン成功:', qrData);
                    // QRコードスキャン成功時の処理
                    // キャプチャページのQR結果表示を更新
                    const captureQrResult = document.getElementById('capture-qr-result');
                    if (captureQrResult) {
                        captureQrResult.textContent = `注文ID: ${qrData.orderId}, トークン: ${qrData.token}`;
                        captureQrResult.style.display = 'block';
                    }
                    
                    // 確認ページのQR結果表示も更新
                    const confirmQrResult = document.getElementById('confirm-qr-result');
                    if (confirmQrResult) {
                        confirmQrResult.textContent = `注文ID: ${qrData.orderId}, トークン: ${qrData.token}`;
                    }
                    
                    // 1秒後に自動的に次の画面へ
                    setTimeout(() => {
                        navigateTo(scanPage, capturePage, 'capture');
                    }, 1000);
                });
            }, 500); // 500ミリ秒の遅延を追加
        });
    }
    
    // スキャン → ホーム
    if (backToHomeButton) {
        backToHomeButton.addEventListener('click', function() {
            stopQRScanner(); // QRスキャナーを停止
            navigateTo(scanPage, homePage, 'home');
        });
    }
    
    // 撮影 → スキャン
    if (backToScanButton) {
        backToScanButton.addEventListener('click', function() {
            navigateTo(capturePage, scanPage, 'scan');
        });
    }
    
    // 確認 → 撮影
    if (backToCaptureButton) {
        backToCaptureButton.addEventListener('click', function() {
            navigateTo(confirmPage, capturePage, 'capture');
        });
    }
    
    // 確認 → 撮影 (撮り直し)
    if (retakeButton) {
        retakeButton.addEventListener('click', function() {
            navigateTo(confirmPage, capturePage, 'capture');
        });
    }
    
    // 送信ボタンのイベントリスナーを上書き
    const sendButton = document.getElementById('sendButton');
    if (sendButton) {
        // 既存のイベントリスナーを削除
        const newSendButton = sendButton.cloneNode(true);
        sendButton.parentNode.replaceChild(newSendButton, sendButton);
        
        // 新しいイベントリスナーを追加
        newSendButton.addEventListener('click', function() {
            console.log('Slackに送信開始');
            // 既存の送信処理を実行
            sendToSlack();
            
            // 完了画面の情報を更新
            updateCompletionInfo();
            
            // 完了画面に遷移
            navigateTo(confirmPage, completionPage, 'completion');
            
            // 3秒カウントダウン後にホームに戻る
            let count = 3;
            const countdown = document.querySelector('.countdown');
            
            const timer = setInterval(() => {
                count--;
                countdown.textContent = `${count}秒後にホーム画面に戻ります...`;
                
                if (count <= 0) {
                    clearInterval(timer);
                    resetAll();
                    navigateTo(completionPage, homePage, 'home');
                }
            }, 1000);
        });
    }
    
    // テキストのみ送信ボタンのイベントリスナーを上書き
    const sendTextOnlyButton = document.getElementById('sendTextOnlyButton');
    if (sendTextOnlyButton) {
        // 既存のイベントリスナーを削除
        const newSendTextOnlyButton = sendTextOnlyButton.cloneNode(true);
        sendTextOnlyButton.parentNode.replaceChild(newSendTextOnlyButton, sendTextOnlyButton);
        
        // 新しいイベントリスナーを追加
        newSendTextOnlyButton.addEventListener('click', function() {
            console.log('テキストのみ送信開始');
            // 既存の送信処理を実行
            sendTextOnlyToSlack();
            
            // 完了画面の情報を更新（画像なし）
            updateCompletionInfo(true);
            
            // 完了画面に遷移
            navigateTo(confirmPage, completionPage, 'completion');
            
            // 3秒カウントダウン後にホームに戻る
            let count = 3;
            const countdown = document.querySelector('.countdown');
            
            const timer = setInterval(() => {
                count--;
                countdown.textContent = `${count}秒後にホーム画面に戻ります...`;
                
                if (count <= 0) {
                    clearInterval(timer);
                    resetAll();
                    navigateTo(completionPage, homePage, 'home');
                }
            }, 1000);
        });
    }
    
    // 完了 → ホーム
    if (backToHomeFromCompletionButton) {
        backToHomeFromCompletionButton.addEventListener('click', function() {
            resetAll();
            navigateTo(completionPage, homePage, 'home');
        });
    }
    
    // 設定ボタンクリック時
    if (settingsButton) {
        settingsButton.addEventListener('click', function() {
            console.log('設定ボタンクリック');
            // 現在の設定を表示
            const settings = getSettings();
            document.getElementById('botToken').value = settings.botToken || '';
            document.getElementById('channelId').value = settings.channelId || '';
            document.getElementById('proxyUrl').value = settings.proxyUrl || '';
            
            // モーダルを表示
            settingsModal.style.display = 'block';
        });
    }
    
    // 閉じるボタンクリック時
    if (closeButton) {
        closeButton.addEventListener('click', function() {
            settingsModal.style.display = 'none';
        });
    }
    
    // モーダル外クリック時
    window.addEventListener('click', function(event) {
        if (event.target == settingsModal) {
            settingsModal.style.display = 'none';
        }
    });
    
    // 保存ボタンクリック時
    if (saveSettingsButton) {
        saveSettingsButton.addEventListener('click', function() {
            console.log('設定保存ボタンクリック');
            const botToken = document.getElementById('botToken').value;
            const channelId = document.getElementById('channelId').value;
            const proxyUrl = document.getElementById('proxyUrl').value;
            
            // 設定を保存
            saveSettings({
                botToken: botToken,
                channelId: channelId,
                proxyUrl: proxyUrl
            });
            
            // 保存成功メッセージ
            const settingsStatus = document.getElementById('settingsStatus');
            settingsStatus.textContent = '設定を保存しました';
            settingsStatus.className = 'status-message success';
            settingsStatus.style.display = 'block';
            
            // 3秒後にメッセージを非表示
            setTimeout(() => {
                settingsStatus.style.display = 'none';
            }, 3000);
        });
    }
    
    // 完了画面の情報を更新
    function updateCompletionInfo(textOnly = false) {
        // QRコード情報
        const qrResult = document.getElementById('qr-result');
        const completionQrInfo = document.getElementById('completion-qr-info');
        
        if (qrResult && qrResult.dataset.qrData && completionQrInfo) {
            const qrData = JSON.parse(qrResult.dataset.qrData);
            completionQrInfo.textContent = `注文ID: ${qrData.orderId}, トークン: ${qrData.token}`;
        }
        
        // 画像情報
        const completionImageInfo = document.getElementById('completion-image-info');
        if (completionImageInfo) {
            if (textOnly) {
                completionImageInfo.textContent = 'テキストのみ送信されました（画像なし）';
            } else {
                completionImageInfo.textContent = 'トレイ画像が添付されています';
            }
        }
        
        // チャンネル情報
        const completionChannel = document.getElementById('completion-channel');
        if (completionChannel) {
            const settings = getSettings();
            completionChannel.textContent = settings.channelId || '未設定';
        }
    }
    
    // すべてをリセット
    function resetAll() {
        console.log('すべてをリセット');
        resetCamera();
        stopQRScanner();
        
        // QR結果表示をクリア
        const qrResult = document.getElementById('qr-result');
        if (qrResult) {
            qrResult.textContent = '';
            qrResult.style.display = 'none';
            delete qrResult.dataset.qrData;
        }
        
        const captureQrResult = document.getElementById('capture-qr-result');
        if (captureQrResult) {
            captureQrResult.textContent = '';
            captureQrResult.style.display = 'none';
        }
        
        const confirmQrResult = document.getElementById('confirm-qr-result');
        if (confirmQrResult) {
            confirmQrResult.textContent = '';
        }
        
        // ステータス表示をクリア
        const statusElement = document.getElementById('status');
        if (statusElement) {
            statusElement.style.display = 'none';
        }
    }
    
    // デバッグ情報
    console.log('ページ読み込み完了');
});
    </script>
</body>
</html>
